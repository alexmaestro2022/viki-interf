<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VIKI — Telegram-native AI Platform (Mock)</title>

    <!-- Tailwind via CDN (для быстрого предпросмотра) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {},
            boxShadow: {},
          },
        },
      };
    </script>

    <!-- React 18 UMD + Babel (для JSX в браузере) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      html, body { height: 100%; }
      /* Слегка сгладим фон, чтобы он был ближе к вашим макетам */
      .app-bg {
        background: linear-gradient(135deg, #0b1220 0%, #0f172a 45%, #111827 100%);
      }
    </style>
  </head>
  <body class="min-h-screen app-bg text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      // ---------------- Helper mini-components ----------------
      const { useMemo, useState } = React;

      function Icon({ name, className = "w-5 h-5" }) {
        const stroke = "currentColor";
        const common = { fill: "none", stroke, strokeWidth: 1.5, strokeLinecap: "round", strokeLinejoin: "round" };
        switch (name) {
          case "logo":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M4 12a8 8 0 1016 0A8 8 0 104 12z" />
                <path d="M8 12h8M12 8v8" />
              </svg>
            );
          case "project":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M3 7h18M7 3h10M5 7v12a2 2 0 002 2h10a2 2 0 002-2V7" />
              </svg>
            );
          case "agent":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M12 14a5 5 0 100-10 5 5 0 000 10z" />
                <path d="M4 21a8 8 0 0116 0" />
              </svg>
            );
          case "kb":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M4 5h12a4 4 0 014 4v10H8a4 4 0 01-4-4V5z" />
                <path d="M8 5v10a4 4 0 004 4" />
              </svg>
            );
          case "contacts":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M7 8h10M7 12h8M7 16h6" />
                <path d="M4 4h16v16H4z" />
              </svg>
            );
          case "funnel":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M3 4h18l-6 7v6l-6 3V11L3 4z" />
              </svg>
            );
          case "chat":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M21 12a8 8 0 11-3.2-6.4L21 5l-.6 3.2A7.96 7.96 0 0121 12z" />
                <path d="M7 17l-3 3 .8-4.2" />
              </svg>
            );
          case "crm":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M4 6h16M4 12h10M4 18h7" />
                <path d="M16 11l4 4-4 4" />
              </svg>
            );
          case "analytics":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M4 20h16M7 10v7M12 7v10M17 13v4" />
              </svg>
            );
          case "autopilot":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M12 3l3 6 6 .9-4.5 4.4 1 6.4L12 18l-5.5 2.7 1-6.4L3 9.9 9 9l3-6z" />
              </svg>
            );
          case "settings":
            return (
              <svg viewBox="0 0 24 24" className={className} {...common}>
                <path d="M12 8a4 4 0 100 8 4 4 0 000-8z" />
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V22a2 2 0 01-4 0v-.11a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H2a2 2 0 010-4h.11c.66 0 1.26-.39 1.51-1z" />
              </svg>
            );
          case "play":
            return <svg viewBox="0 0 24 24" className={className} {...common}><path d="M8 5l11 7-11 7V5z"/></svg>;
          case "pause":
            return <svg viewBox="0 0 24 24" className={className} {...common}><path d="M8 5h3v14H8zM13 5h3v14h-3z"/></svg>;
          case "check":
            return <svg viewBox="0 0 24 24" className={className} {...common}><path d="M5 13l4 4L19 7"/></svg>;
          case "warning":
            return <svg viewBox="0 0 24 24" className={className} {...common}><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>;
          default:
            return null;
        }
      }

      function Badge({ children, color = "slate" }) {
        const map = {
          slate: "bg-slate-800/60 text-slate-200 border-slate-700",
          green: "bg-emerald-500/15 text-emerald-300 border-emerald-400/20",
          yellow: "bg-amber-500/15 text-amber-300 border-amber-400/20",
          red: "bg-rose-500/15 text-rose-300 border-rose-400/20",
          blue: "bg-sky-500/15 text-sky-300 border-sky-400/20",
          violet: "bg-violet-500/15 text-violet-300 border-violet-400/20",
        };
        return (
          <span className={`inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full border ${map[color]}`}>
            {children}
          </span>
        );
      }

      function Card({ title, subtitle, right, children, className = "" }) {
        return (
          <div className={`rounded-2xl border border-slate-800 bg-slate-900/70 shadow-none ${className}`}>
            {(title || right) && (
              <div className="flex items-center justify-between px-4 py-3 border-b border-slate-800">
                <div>
                  <h3 className="text-sm font-semibold text-slate-100">{title}</h3>
                  {subtitle && <p className="text-xs text-slate-400 mt-0.5">{subtitle}</p>}
                </div>
                <div className="flex items-center gap-2">{right}</div>
              </div>
            )}
            <div className="p-4">{children}</div>
          </div>
        );
      }

      function Button({ children, onClick, variant = "primary", size = "md", className = "", disabled }) {
        const v = {
          primary: "bg-indigo-500 text-white hover:bg-indigo-400",
          ghost: "bg-transparent text-slate-200 hover:bg-slate-800",
          outline: "bg-transparent text-slate-100 border border-slate-700 hover:bg-slate-800",
          danger: "bg-rose-600 text-white hover:bg-rose-500",
          success: "bg-emerald-600 text-white hover:bg-emerald-500",
        };
        const s = { sm: "px-3 py-1.5 text-sm rounded-xl", md: "px-3.5 py-2 text-sm rounded-xl", lg: "px-4 py-2.5 text-base rounded-2xl" };
        return (
          <button onClick={onClick} disabled={disabled} className={`${v[variant]} ${s[size]} transition-colors ${disabled ? "opacity-50 cursor-not-allowed" : ""} ${className}`}>
            {children}
          </button>
        );
      }

      function Toggle({ checked, onChange }) {
        return (
          <button onClick={() => onChange(!checked)} className={`w-11 h-6 rounded-full transition-all ${checked ? "bg-emerald-500" : "bg-slate-600"} relative`}>
            <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-all ${checked ? "translate-x-5" : ""}`} />
          </button>
        );
      }

      function Field({ label, hint, children, required }) {
        return (
          <label className="block">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-slate-200">
                {label}{required && <span className="text-rose-400">*</span>}
              </span>
              {hint && <span className="text-xs text-slate-500">{hint}</span>}
            </div>
            <div className="mt-1.5">{children}</div>
          </label>
        );
      }

      // ---------------- Mock data (определены до использования!) ----------------
      const MOCK_AGENTS = [
        { id: "agent_001", username: "@promo_agent_01", status: "active",   warm: 0.91, geo: "KZ", messagesToday: 437, flood: false },
        { id: "agent_002", username: "@promo_agent_02", status: "cooldown", warm: 0.72, geo: "RU", messagesToday: 188, flood: true  },
        { id: "agent_003", username: "@sales_maria",    status: "paused",   warm: 0.83, geo: "TR", messagesToday: 0,   flood: false },
      ];

      const MOCK_CONTACT_BASES = [
        { id: "base_main",    name: "Активная база: Лиды Май", size: 18240, status: "active"   },
        { id: "base_webinar", name: "Вебинар Апрель (архив)",  size:  5320, status: "archived" },
      ];

      const MOCK_PROJECTS = [
        {
          id: "proj_001",
          name: "Продажа кухонь",
          status: "active",
          agentIds: ["agent_001"],
          funnelId: "funnel_kitchen",
          kbId: "kb_main",
          activeContactBaseId: "base_main",
          autoOptimize: false,
          kpi: { conv: 0.064, reply: 0.41, ctr: 0.23 },
        },
        {
          id: "proj_002",
          name: "Рекрутинг курьеров",
          status: "paused",
          agentIds: ["agent_002"],
          funnelId: "funnel_hr",
          kbId: "kb_hr",
          activeContactBaseId: "base_main",
          autoOptimize: true,
          kpi: { conv: 0.028, reply: 0.36, ctr: 0.19 },
        },
      ];

      // ---------------- Views (усечённый набор для демонстрации) ----------------
      function ProjectsView({ projects, onOpenWizard, onToggleProject }) {
        return (
          <div className="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <Card
              title="Проекты"
              subtitle="Централизованное управление сущностями и запуском"
              right={<Button onClick={onOpenWizard}>+ Новый проект</Button>}
              className="xl:col-span-2"
            >
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {projects.map((p) => (
                  <div key={p.id} className="rounded-xl border border-slate-800 p-3 hover:bg-slate-900 transition">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Icon name="project" />
                        <div>
                          <div className="font-medium text-slate-100">{p.name}</div>
                          <div className="text-xs text-slate-400">Funnel: <span className="font-mono text-slate-300">{p.funnelId}</span></div>
                        </div>
                      </div>
                      <Badge color={p.status === "active" ? "green" : p.status === "paused" ? "yellow" : "slate"}>{p.status}</Badge>
                    </div>
                    <div className="mt-3 grid grid-cols-3 gap-2 text-center">
                      <div className="rounded-lg bg-slate-800 py-2">
                        <div className="text-xs text-slate-400">Reply</div>
                        <div className="font-semibold text-slate-100">{Math.round(p.kpi.reply * 100)}%</div>
                      </div>
                      <div className="rounded-lg bg-slate-800 py-2">
                        <div className="text-xs text-slate-400">CTR</div>
                        <div className="font-semibold text-slate-100">{Math.round(p.kpi.ctr * 100)}%</div>
                      </div>
                      <div className="rounded-lg bg-slate-800 py-2">
                        <div className="text-xs text-slate-400">Conv</div>
                        <div className="font-semibold text-slate-100">{(p.kpi.conv * 100).toFixed(1)}%</div>
                      </div>
                    </div>
                    <div className="mt-3 flex items-center justify-between">
                      <div className="text-xs text-slate-400">
                        Активная база: <span className="font-mono text-slate-300">{p.activeContactBaseId}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={(e) => { e.stopPropagation(); onToggleProject(p); }}
                        >
                          {p.status === "active" ? "Пауза" : "Запустить"}
                        </Button>
                        <Button size="sm">Открыть</Button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </Card>

            <Card title="Статусы и уведомления" subtitle="Системные события и алерты">
              <ul className="space-y-2 text-sm text-slate-200">
                <li className="flex items-start gap-2"><Icon name="check" className="w-4 h-4 text-emerald-400 mt-0.5"/>Все сервисы работают штатно</li>
                <li className="flex items-start gap-2"><Icon name="warning" className="w-4 h-4 text-amber-400 mt-0.5"/>У агента @promo_agent_02 FloodWait — включён cooldown</li>
                <li className="flex items-start gap-2"><Icon name="warning" className="w-4 h-4 text-amber-400 mt-0.5"/>Попытка подключить вторую активную базу — отклонено политикой</li>
              </ul>
            </Card>
          </div>
        );
      }

      // ---------------- Active Project panel (внизу страницы) ----------------
      function ActiveProjectPanel({ project }) {
        if (!project) return null;
        return (
          <div className="max-w-7xl mx-auto px-4 mt-2">
            <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
              <div className="text-sm font-semibold text-slate-200 mb-2">Активный проект</div>
              <div className="grid gap-3 sm:grid-cols-3 text-sm">
                <div>
                  <div className="text-slate-500">Проект</div>
                  <div className="text-slate-100">{project.name}</div>
                </div>
                <div>
                  <div className="text-slate-500">Контактная база</div>
                  <div className="font-mono text-slate-300">{project.activeContactBaseId}</div>
                </div>
                <div className="sm:text-right">
                  <div className="text-slate-500">Статус</div>
                  <Badge color={project.status === "active" ? "green" : "yellow"}>{project.status}</Badge>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ---------------- Навигация + App ----------------
      const NAV = [
        { id: "projects",  label: "Проекты",   icon: "project"   },
        { id: "agents",    label: "Агенты",     icon: "agent"     },
        { id: "kb",        label: "База знаний",icon: "kb"        },
        { id: "contacts",  label: "Контакты",   icon: "contacts"  },
        { id: "funnels",   label: "Воронки",    icon: "funnel"    },
        { id: "dialogues", label: "Диалоги",    icon: "chat"      },
        { id: "crm",       label: "CRM",        icon: "crm"       },
        { id: "analytics", label: "Аналитика",  icon: "analytics" },
        { id: "autopilot", label: "Автопилот",  icon: "autopilot" },
        { id: "settings",  label: "Настройки",  icon: "settings"  },
      ];

      function VIKIUserApp() {
        const [tab, setTab] = useState("projects");
        const [projects, setProjects] = useState(MOCK_PROJECTS);
        const [wizard, setWizard] = useState(false);
        const currentProject = useMemo(() => projects[0], [projects]);

        function handleToggleProject(p) {
          setProjects(prev =>
            prev.map(x => x.id === p.id ? { ...x, status: x.status === "active" ? "paused" : "active" } : x)
          );
        }

        function Content() {
          switch (tab) {
            case "projects":
            default:
              return (
                <ProjectsView
                  projects={projects}
                  onOpenWizard={() => setWizard(true)}
                  onToggleProject={handleToggleProject}
                />
              );
          }
        }

        return (
          <>
            {/* Top bar */}
            <header className="sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-slate-800">
              <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-9 h-9 rounded-2xl bg-indigo-600 grid place-content-center text-white shadow-lg shadow-indigo-600/30">
                    <Icon name="logo" className="w-4 h-4"/>
                  </div>
                  <div>
                    <div className="font-semibold">VIKI</div>
                    <div className="text-xs text-slate-400">Telegram-native AI Platform</div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <Button variant="outline" size="sm">Помощь</Button>
                  <Button size="sm" onClick={() => setWizard(true)}>Создать проект</Button>
                </div>
              </div>
            </header>

            {/* Основная раскладка: слева меню (sticky), справа контент в карточке */}
            <div className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-[260px,1fr] gap-6">
              {/* Sidebar */}
              <aside className="lg:sticky lg:top-[72px] h-max">
                <div className="mb-2 text-xs uppercase tracking-wide text-slate-500">Меню</div>
                <nav className="rounded-2xl border border-slate-800 bg-slate-900/70 p-2">
                  {NAV.map((n) => (
                    <button
                      key={n.id}
                      onClick={() => setTab(n.id)}
                      className={`w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm transition-colors
                        ${tab === n.id
                          ? "bg-indigo-600/90 text-white shadow-inner"
                          : "text-slate-200 hover:bg-slate-800"}`}
                    >
                      <Icon name={n.icon} className="w-4 h-4" />
                      {n.label}
                    </button>
                  ))}
                </nav>
              </aside>

              {/* Content */}
              <main aria-label="Интерфейс пользователя VIKI">
                <Card
                  title={NAV.find(n => n.id === tab)?.label}
                  subtitle="Интерфейс пользователя VIKI"
                >
                  <Content />
                </Card>
              </main>
            </div>

            {/* Панель активного проекта внизу страницы */}
            <ActiveProjectPanel project={currentProject} />
          </>
        );
      }

      // ---------------- Mount ----------------
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<VIKIUserApp />);

      // ---------------- Smoke tests (консоль) ----------------
      (function runSmokeTests() {
        try {
          const sidebar = document.querySelector("aside nav");
          const mainCardTitle = Array.from(document.querySelectorAll("h3")).find(h => h.textContent.trim().length);
          const grid = document.querySelector("div.max-w-7xl.mx-auto.px-4.py-6.grid");

          console.log("[SMOKE] sidebar exists:", !!sidebar);
          console.log("[SMOKE] main card title:", mainCardTitle?.textContent || "<none>");
          console.log("[SMOKE] grid layout classes:", grid?.className || "<none>");

          if (!sidebar) throw new Error("Sidebar not rendered");
          if (!grid?.className.includes("lg:grid-cols-[260px,1fr]")) {
            throw new Error("Grid columns do not match expected layout");
          }
          console.log("%cAll smoke tests passed", "color: #10b981");
        } catch (e) {
          console.error("[SMOKE] failed:", e);
        }
      })();
    </script>
  </body>
</html>

